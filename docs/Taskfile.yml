# https://taskfile.dev/usage
version: '3'

vars:
  TOOL: tool

tasks:
  default:
    cmds:
      - task: build

  01_setup:
    desc: 'Install dev tools'
    aliases:
      - setup
      - s
    cmds:
      # https://golangci-lint.run/welcome/install/
      - brew install golangci-lint
      - brew upgrade golangci-lint
      - pip install --user mkdocs
      # parse profiling data
      - go install github.com/google/pprof@latest
  
  01_setup_goreleaser:
    desc: 'Install goreleaser and child tools'
    cmds:
      - brew install goreleaser
      # cataloging artifacts
      - brew install syft
      # signing artifacts
      # - brew install cosign


  03_test-go:
    desc: Test tool for your local system
    aliases:
      - test
      - t
    cmds:
      - golangci-lint run
      - go test -cover ./pkg/*
      - task: 02_build
      - task: 03_test-package

  02_build:
    desc: Build tool for your local system
    aliases:
      - build
      - b
    cmds:
      - go fmt
      - go build -ldflags="-s -w"
      - task: 02_mkdocs

  02_mkdocs:
    desc: Uses mkdocs to build documentation site from docs
    aliases: ["mkdocs"]
    cmds:
      - go generate ./docs
      # references mkdocs.yml
      - mkdocs build

  03_build-snapshot:
    desc: Build a snapshot for all platforms using goreleaser
    aliases:
      - build-snapshot
      - bs
    cmds:
      - go generate ./docs
      - goreleaser release --snapshot --clean --skip=homebrew

  04_profile-generate:
    desc: Capture profiling data from a tool generate of the examples.
    aliases:
      - profile
    cmds:
      - mkdir -p ./profiling
      - ./{{.TOOL}} generate -B examples --profiledir ./profiling {{.CLI_ARGS}}
      - go tool pprof -png -output ./profiling/cpu.png ./tool ./profiling/profile_cpu.pb.gz
      - go tool pprof -png -output ./profiling/heap.png ./{{.TOOL}} ./profiling/profile_heap.pb.gz
      #- go tool pprof -http=0.0.0.0:8654 ./{{.TOOL}} ./profiling/profile_cpu.pb.gz
      #- go tool pprof -http=0.0.0.0:8654 ./{{.TOOL}} ./profiling/profile_heap.pb.gz

  05_docker-compose-build:
    desc: Build docker container
    aliases:
      - dcb
    cmds:
      - docker-compose -f ./docker/compose.yml build
  
  05_docker-compose-up:
    desc: Build docker container
    aliases:
      - dcu
    cmds:
      - docker-compose -f ./docker/compose.yml up -d
